<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raw Sensor Panel (iPhone Web)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:linear-gradient(180deg,#1d3b8f 0%, #0f1d4f 70%, #0b0b10 100%); color:#e9e9ef; font-family:-apple-system,system-ui,Segoe UI,Arial; }
    .wrap { padding:14px; max-width:720px; margin:0 auto; }
    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .lang-switch { display:flex; gap:6px; }
    .lang-btn { padding:6px 10px; border-radius:999px; border:1px solid #2a2a45; background:#0f1530; color:#dfe4ff; font-weight:700; font-size:12px; cursor:pointer; }
    .lang-btn.active { background:#1b2a6b; border-color:#4b5aa8; }
    .btn { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a2a45; background:#10162f; color:#fff; font-weight:800; }
    .btn:active{ transform:scale(.99); }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .panel { display:grid; grid-template-columns:1fr; gap:8px; margin-top:12px; }
    .card { background:transparent; border:none; border-radius:16px; padding:8px 4px; }
    .permission-card { position:sticky; top:8px; z-index:20; background:rgba(84, 20, 20, 0.55); border:1px solid rgba(255, 120, 120, 0.45); border-radius:16px; padding:12px; backdrop-filter:blur(6px); box-shadow:0 8px 18px rgba(0,0,0,.35); }
    .permission-title { justify-content:flex-start; color:#ffd6d6; text-transform:none; letter-spacing:.2px; font-size:13px; }
    .permission-title .icon { font-size:14px; }
    .permission-text { margin:6px 0 10px; font-size:12px; color:#f5d9d9; }
    .permission-steps { margin:8px 0; }
    .permission-steps ol { margin:6px 0 0 18px; padding:0; font-size:12px; color:#f2cfcf; line-height:1.4; }
    .permission-steps li { margin:4px 0; }
    .permission-note { margin:8px 0 0; font-size:11px; color:#f2cfcf; }
    .title { font-weight:700; opacity:.9; margin-bottom:8px; display:flex; justify-content:center; gap:10px; font-size:12px; text-transform:uppercase; letter-spacing:.6px; text-shadow:0 1px 4px rgba(0,0,0,.6); }
    .rows { display:grid; grid-template-columns:1fr; gap:8px; }
    .row { display:flex; flex-direction:column; align-items:flex-start; gap:4px; padding:8px 12px; background:#000000; border-radius:16px; margin:2px 0; }
    .row.actions { background:transparent; padding:0; }
    .btn-group { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:8px; width:100%; }
    .k { color:#aeb4c8; font-size:11px; width:100%; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .label { flex:1; }
    .info-btn { border:none; background:transparent; color:#aeb4c8; font-size:12px; cursor:pointer; padding:2px; }
    .info-btn:focus { outline:2px solid #4b5aa8; border-radius:6px; }
    .desc { font-size:11px; color:#cbd1e6; line-height:1.3; display:none; }
    .desc.open { display:block; }
    .v { color:#ffffff; font-weight:700; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-variant-numeric:tabular-nums; text-align:right; width:100%; }
    .field-input,
    .field-textarea { width:100%; border-radius:12px; border:1px solid #2a2a45; background:#0b1124; color:#e9e9ef; padding:8px 10px; font-size:13px; }
    .field-textarea { min-height:68px; resize:vertical; }
    .canvas-wrap { width:100%; background:#0b1124; border-radius:16px; padding:8px; border:1px solid #2a2a45; }
    canvas { width:100%; height:180px; display:block; }
    .hidden { display:none !important; }
    .note { font-size:11px; color:#aeb4c8; margin:4px 12px 0; line-height:1.35; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="lang-switch" role="tablist" aria-label="Language">
        <button class="lang-btn active" type="button" data-lang="pt">PT</button>
        <button class="lang-btn" type="button" data-lang="en">EN</button>
        <button class="lang-btn" type="button" data-lang="es">ES</button>
      </div>
      <button class="btn" id="startBtn" data-i18n="start_btn">Iniciar (pedir permiss√µes)</button>
    </div>

    <div class="panel">
      <div class="card permission-card hidden" id="geoPermissionCard" role="status" aria-live="polite">
        <div class="title permission-title">
          <span class="icon">‚ö†Ô∏è</span>
          <span data-i18n="geo_perm_title">Permiss√£o de localiza√ß√£o negada</span>
        </div>
        <p class="permission-text" data-i18n="geo_perm_explain">No Android, se a localiza√ß√£o for negada na primeira vez, o navegador n√£o pergunta novamente automaticamente.</p>
        <div class="permission-steps">
          <div class="permission-text" data-i18n="geo_perm_steps_title">Chrome (Android):</div>
          <ol>
            <li data-i18n="geo_perm_step1">Toque no √≠cone üîí ao lado da barra de endere√ßo</li>
            <li data-i18n="geo_perm_step2">V√° em Permiss√µes</li>
            <li data-i18n="geo_perm_step3">Ative Localiza√ß√£o</li>
            <li data-i18n="geo_perm_step4">Recarregue a p√°gina</li>
          </ol>
        </div>
        <div class="row actions">
          <div class="btn-group">
            <button class="btn" id="retryGeoBtn" type="button" data-i18n="btn_retry_geo">Tentar novamente</button>
          </div>
        </div>
        <p class="permission-note" data-i18n="geo_perm_retry_note">Funciona apenas se o navegador ainda permitir novo prompt.</p>
      </div>
      <div class="card" data-section="gps">
        <div class="title"><span data-i18n="section_gps">GPS / Fix</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_lat">Latitude</span>
              <button class="info-btn" type="button" data-info-for="lat">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_lat"></div>
            <div class="v" id="lat">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_lat_dms">Lat (DMS)</span>
            </div>
            <div class="v" id="latDms">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_lon">Longitude</span>
              <button class="info-btn" type="button" data-info-for="lon">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_lon"></div>
            <div class="v" id="lon">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_lon_dms">Lon (DMS)</span>
            </div>
            <div class="v" id="lonDms">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_geo_status">Status GPS</span>
            </div>
            <div class="v" id="geoStatus">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_alt">Altitude (m)</span>
              <button class="info-btn" type="button" data-info-for="alt">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_alt"></div>
            <div class="v" id="alt">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_hacc">Acc H (m)</span>
              <button class="info-btn" type="button" data-info-for="hacc">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_hacc"></div>
            <div class="v" id="hacc">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_vacc">AltAcc (m)</span>
              <button class="info-btn" type="button" data-info-for="vacc">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_vacc"></div>
            <div class="v" id="vacc">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_sigq">Qualidade sinal</span>
              <button class="info-btn" type="button" data-info-for="sigQ">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_sigq"></div>
            <div class="v" id="sigQ">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_bearing">Bearing (¬∞)</span>
              <button class="info-btn" type="button" data-info-for="bearing">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_bearing"></div>
            <div class="v" id="bearing">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_bearing_src">Fonte rumo</span>
              <button class="info-btn" type="button" data-info-for="bearingSrc">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_bearing_src"></div>
            <div class="v" id="bearingSrc">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_speed">Speed (km/h)</span>
              <button class="info-btn" type="button" data-info-for="spd">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_speed"></div>
            <div class="v" id="spd">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_ts">Timestamp</span>
              <button class="info-btn" type="button" data-info-for="ts">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_ts"></div>
            <div class="v" id="ts">‚Äî</div>
          </div>
          <div class="row actions hidden" id="mapsRow">
            <div class="btn-group">
              <a class="btn" id="mapsLink" target="_blank" rel="noopener" data-i18n="btn_maps">Abrir no Google Maps</a>
            </div>
          </div>
        </div>
        <p class="note" data-i18n="gps_update_note">A taxa de atualiza√ß√£o do GPS √© controlada pelo sistema operacional e navegador. A Web API n√£o garante atualiza√ß√£o fixa (ex.: 1 Hz).</p>
        <p class="note hidden" id="geoInstruction" data-i18n="geo_instruction">Ative a localiza√ß√£o nas permiss√µes do navegador.</p>
      </div>

      <div class="card" data-section="telemetry">
        <div class="title"><span data-i18n="section_telemetry">Telemetria</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_dtGps">Œît GPS (ms)</span>
              <button class="info-btn" type="button" data-info-for="dtGps">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_dtGps"></div>
            <div class="v" id="dtGps">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_updateAge">Update (s)</span>
              <button class="info-btn" type="button" data-info-for="updateAge">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_updateAge"></div>
            <div class="v" id="updateAge">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_dLast">Dist. entre updates (m)</span>
              <button class="info-btn" type="button" data-info-for="dLast">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_dLast"></div>
            <div class="v" id="dLast">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_dTot">Dist√¢ncia total (m)</span>
              <button class="info-btn" type="button" data-info-for="dTot">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_dTot"></div>
            <div class="v" id="dTot">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_vAvg">Vel. m√©dia</span>
              <button class="info-btn" type="button" data-info-for="vAvg">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_vAvg"></div>
            <div class="v" id="vAvg">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_vMax">Vel. m√°x (km/h)</span>
              <button class="info-btn" type="button" data-info-for="vMax">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_vMax"></div>
            <div class="v" id="vMax">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_dAlt">Œî Altitude (m)</span>
              <button class="info-btn" type="button" data-info-for="dAlt">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_dAlt"></div>
            <div class="v" id="dAlt">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_vVert">Vel. vertical (m/s)</span>
              <button class="info-btn" type="button" data-info-for="vVert">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_vVert"></div>
            <div class="v" id="vVert">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_pace">Ritmo (min/km)</span>
              <button class="info-btn" type="button" data-info-for="pace">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_pace"></div>
            <div class="v" id="pace">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card" data-section="gpx">
        <div class="title"><span data-i18n="section_gpx_recording">Grava√ß√£o</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_activity_name">Nome da atividade</span>
            </div>
            <input class="field-input" id="activityName" type="text" maxlength="80" data-i18n-placeholder="placeholder_activity_name" />
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_activity_note">Observa√ß√£o</span>
            </div>
            <textarea class="field-textarea" id="activityNote" maxlength="200" data-i18n-placeholder="placeholder_activity_note"></textarea>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rec_status">Status</span>
            </div>
            <div class="v" id="recStatus">Parado</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rec_points">Pontos gravados</span>
            </div>
            <div class="v" id="recPoints">0</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rec_time">Tempo decorrido</span>
            </div>
            <div class="v" id="recTime">00:00</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rec_distance">Dist√¢ncia total (m)</span>
            </div>
            <div class="v" id="recDistance">0.0</div>
          </div>
          <div class="row actions">
            <div class="btn-group">
              <button class="btn" id="recStartBtn" type="button" data-i18n="btn_rec_start">Iniciar grava√ß√£o</button>
              <button class="btn" id="recPauseBtn" type="button" data-i18n="btn_rec_pause">Pausar</button>
              <button class="btn" id="recResumeBtn" type="button" data-i18n="btn_rec_resume">Retomar</button>
              <button class="btn" id="recStopBtn" type="button" data-i18n="btn_rec_stop">Parar e Baixar GPX</button>
              <button class="btn" id="recResetBtn" type="button" data-i18n="btn_rec_reset">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" data-section="elevation">
        <div class="title"><span data-i18n="section_elevation">Eleva√ß√£o</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_gain">Ganho acumulado (m)</span>
            </div>
            <div class="v" id="elevGain">0.0</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_loss">Perda acumulada (m)</span>
            </div>
            <div class="v" id="elevLoss">0.0</div>
          </div>
          <div class="row" data-keep-visible>
            <div class="k">
              <span class="label" data-i18n="label_grade">Inclina√ß√£o √∫ltimo trecho (%)</span>
            </div>
            <div class="v" id="elevGrade">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_profile">Perfil altim√©trico</span>
            </div>
            <div class="canvas-wrap">
              <canvas id="elevChart" width="600" height="180"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card" data-section="orientation">
        <div class="title"><span data-i18n="section_orientation">Orienta√ß√£o</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_ra">rot alpha</span>
              <button class="info-btn" type="button" data-info-for="ra">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_ra"></div>
            <div class="v" id="ra">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rb">rot beta</span>
              <button class="info-btn" type="button" data-info-for="rb">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_rb"></div>
            <div class="v" id="rb">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_rg">rot gamma</span>
              <button class="info-btn" type="button" data-info-for="rg">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_rg"></div>
            <div class="v" id="rg">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_cHead">compassHeading (¬∞)</span>
              <button class="info-btn" type="button" data-info-for="cHead">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_cHead"></div>
            <div class="v" id="cHead">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_cAcc">compassAccuracy (¬∞)</span>
              <button class="info-btn" type="button" data-info-for="cAcc">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_cAcc"></div>
            <div class="v" id="cAcc">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card" data-section="motion">
        <div class="title"><span data-i18n="section_motion">Movimento</span></div>
        <div class="rows">
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_ax">acc x</span>
              <button class="info-btn" type="button" data-info-for="ax">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_ax"></div>
            <div class="v" id="ax">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_ay">acc y</span>
              <button class="info-btn" type="button" data-info-for="ay">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_ay"></div>
            <div class="v" id="ay">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_az">acc z</span>
              <button class="info-btn" type="button" data-info-for="az">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_az"></div>
            <div class="v" id="az">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_agx">acc+g x</span>
              <button class="info-btn" type="button" data-info-for="agx">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_agx"></div>
            <div class="v" id="agx">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_agy">acc+g y</span>
              <button class="info-btn" type="button" data-info-for="agy">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_agy"></div>
            <div class="v" id="agy">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_agz">acc+g z</span>
              <button class="info-btn" type="button" data-info-for="agz">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_agz"></div>
            <div class="v" id="agz">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">
              <span class="label" data-i18n="label_gforce">G-Force (g)</span>
              <button class="info-btn" type="button" data-info-for="gforce">‚ÑπÔ∏è</button>
            </div>
            <div class="desc" data-i18n="desc_gforce"></div>
            <div class="v" id="gforce">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  function fmt(n, d=6) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(d) : null; }
  function fmt1(n) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(1) : null; }
  function fmt0(n) { return (typeof n === "number" && isFinite(n)) ? String(Math.round(n)) : null; }

  const translations = {
    pt: {
      start_btn: "Iniciar (pedir permiss√µes)",
      section_gps: "GPS / Fix",
      section_telemetry: "Telemetria",
      section_gpx_recording: "Grava√ß√£o",
      section_elevation: "Eleva√ß√£o",
      label_activity_name: "Nome da atividade",
      label_activity_note: "Observa√ß√£o",
      placeholder_activity_name: "Ex: Corrida no parque",
      placeholder_activity_note: "Ex: Subidas fortes na metade final.",
      label_gain: "Ganho acumulado (m)",
      label_loss: "Perda acumulada (m)",
      label_grade: "Inclina√ß√£o √∫ltimo trecho (%)",
      label_profile: "Perfil altim√©trico",
      section_orientation: "Orienta√ß√£o",
      section_motion: "Movimento",
      label_lat: "Latitude",
      label_lat_dms: "Lat (DMS)",
      label_lon: "Longitude",
      label_lon_dms: "Lon (DMS)",
      label_geo_status: "Status GPS",
      label_alt: "Altitude (m)",
      label_hacc: "Acc H (m)",
      label_vacc: "AltAcc (m)",
      label_sigq: "Qualidade sinal",
      label_bearing: "Rumo (¬∞)",
      label_bearing_src: "Fonte do rumo",
      label_speed: "Velocidade (km/h)",
      label_ts: "Timestamp",
      label_dtGps: "Œît GPS (ms)",
      label_updateAge: "Atualiza√ß√£o (s)",
      label_dLast: "Dist. entre updates (m)",
      label_dTot: "Dist√¢ncia total (m)",
      label_vAvg: "Vel. m√©dia",
      label_vMax: "Vel. m√°x (km/h)",
      label_dAlt: "Œî Altitude (m)",
      label_vVert: "Vel. vertical (m/s)",
      label_pace: "Ritmo (min/km)",
      label_rec_status: "Status",
      label_rec_points: "Pontos gravados",
      label_rec_time: "Tempo decorrido",
      label_rec_distance: "Dist√¢ncia total (m)",
      label_ra: "rot alpha",
      label_rb: "rot beta",
      label_rg: "rot gamma",
      label_cHead: "compassHeading (¬∞)",
      label_cAcc: "compassAccuracy (¬∞)",
      label_ax: "acc x",
      label_ay: "acc y",
      label_az: "acc z",
      label_agx: "acc+g x",
      label_agy: "acc+g y",
      label_agz: "acc+g z",
      label_gforce: "G-Force (g)",
      desc_lat: "Latitude em graus decimais (N/S).",
      desc_lon: "Longitude em graus decimais (L/O).",
      desc_alt: "Altitude estimada pelo GPS acima do n√≠vel do mar.",
      desc_hacc: "Precis√£o horizontal estimada do GPS (menor √© melhor).",
      desc_vacc: "Precis√£o vertical/altitude estimada do GPS.",
      desc_sigq: "Classifica√ß√£o simples da qualidade do sinal GPS.",
      desc_bearing: "Dire√ß√£o de deslocamento em graus (0¬∞ = Norte).",
      desc_bearing_src: "Origem do rumo: GPS ou b√∫ssola.",
      desc_speed: "Velocidade atual estimada (km/h).",
      desc_ts: "Hora do √∫ltimo fix de GPS.",
      desc_dtGps: "Tempo entre o fix atual e o anterior (ms).",
      desc_updateAge: "Quanto tempo desde o √∫ltimo fix (s).",
      desc_dLast: "Dist√¢ncia percorrida desde o √∫ltimo fix (m).",
      desc_dTot: "Dist√¢ncia total acumulada desde o in√≠cio (m).",
      desc_vAvg: "Velocidade m√©dia desde o primeiro fix (km/h).",
      desc_vMax: "Maior velocidade registrada (km/h).",
      desc_dAlt: "Varia√ß√£o de altitude entre dois fixes (m).",
      desc_vVert: "Velocidade vertical estimada (m/s).",
      desc_pace: "Ritmo estimado por km (min/km).",
      desc_ra: "Rota√ß√£o do dispositivo no eixo Z (alpha).",
      desc_rb: "Rota√ß√£o do dispositivo no eixo X (beta).",
      desc_rg: "Rota√ß√£o do dispositivo no eixo Y (gamma).",
      desc_cHead: "Rumo de b√∫ssola do dispositivo em graus.",
      desc_cAcc: "Precis√£o da b√∫ssola em graus.",
      desc_ax: "Acelera√ß√£o sem gravidade no eixo X (m/s¬≤).",
      desc_ay: "Acelera√ß√£o sem gravidade no eixo Y (m/s¬≤).",
      desc_az: "Acelera√ß√£o sem gravidade no eixo Z (m/s¬≤).",
      desc_agx: "Acelera√ß√£o com gravidade no eixo X (m/s¬≤).",
      desc_agy: "Acelera√ß√£o com gravidade no eixo Y (m/s¬≤).",
      desc_agz: "Acelera√ß√£o com gravidade no eixo Z (m/s¬≤).",
      desc_gforce: "Magnitude da acelera√ß√£o em unidades de G.",
      btn_rec_start: "Iniciar grava√ß√£o",
      btn_rec_pause: "Pausar",
      btn_rec_resume: "Retomar",
      btn_rec_stop: "Parar e Baixar GPX",
      btn_rec_reset: "Reset",
      btn_maps: "Abrir no Google Maps",
      btn_retry_geo: "Tentar novamente",
      geo_perm_title: "Permiss√£o de localiza√ß√£o negada",
      geo_perm_explain: "No Android, se a localiza√ß√£o for negada na primeira vez, o navegador n√£o pergunta novamente automaticamente.",
      geo_perm_steps_title: "Chrome (Android):",
      geo_perm_step1: "Toque no √≠cone üîí ao lado da barra de endere√ßo",
      geo_perm_step2: "V√° em Permiss√µes",
      geo_perm_step3: "Ative Localiza√ß√£o",
      geo_perm_step4: "Recarregue a p√°gina",
      geo_perm_retry_note: "Funciona apenas se o navegador ainda permitir novo prompt.",
      gps_update_note: "A taxa de atualiza√ß√£o do GPS √© controlada pelo sistema operacional e navegador. A Web API n√£o garante atualiza√ß√£o fixa (ex.: 1 Hz).",
      geo_instruction: "Ative a localiza√ß√£o nas permiss√µes do navegador.",
      geo_status_denied: "Permiss√£o de localiza√ß√£o negada",
      rec_status_recording: "Gravando",
      rec_status_paused: "Pausado",
      rec_status_stopped: "Parado",
      rec_status_error_perm: "Erro: permiss√£o negada",
      rec_status_error_unavailable: "Erro: GPS indispon√≠vel",
      rec_status_error_timeout: "Erro: timeout",
      rec_status_error_no_geo: "Erro: GPS n√£o suportado",
      rec_status_no_points: "Sem pontos para exportar",
      info_label: "Mostrar explica√ß√£o",
      sig_excellent: "Excelente",
      sig_good: "Boa",
      sig_bad: "Ruim",
      sig_poor: "P√©ssima",
      bearing_gps: "GPS",
      bearing_compass: "B√∫ssola",
    },
    en: {
      start_btn: "Start (request permissions)",
      section_gps: "GPS / Fix",
      section_telemetry: "Telemetry",
      section_gpx_recording: "Recording",
      section_elevation: "Elevation",
      label_activity_name: "Activity name",
      label_activity_note: "Note",
      placeholder_activity_name: "e.g. Park run",
      placeholder_activity_note: "e.g. Tough climb halfway.",
      label_gain: "Total gain (m)",
      label_loss: "Total loss (m)",
      label_grade: "Last segment grade (%)",
      label_profile: "Elevation profile",
      section_orientation: "Orientation",
      section_motion: "Motion",
      label_lat: "Latitude",
      label_lat_dms: "Lat (DMS)",
      label_lon: "Longitude",
      label_lon_dms: "Lon (DMS)",
      label_geo_status: "GPS status",
      label_alt: "Altitude (m)",
      label_hacc: "H Acc (m)",
      label_vacc: "Alt Acc (m)",
      label_sigq: "Signal quality",
      label_bearing: "Bearing (¬∞)",
      label_bearing_src: "Bearing source",
      label_speed: "Speed (km/h)",
      label_ts: "Timestamp",
      label_dtGps: "Œît GPS (ms)",
      label_updateAge: "Update age (s)",
      label_dLast: "Distance between updates (m)",
      label_dTot: "Total distance (m)",
      label_vAvg: "Avg. speed",
      label_vMax: "Max speed (km/h)",
      label_dAlt: "Œî Altitude (m)",
      label_vVert: "Vertical speed (m/s)",
      label_pace: "Pace (min/km)",
      label_rec_status: "Status",
      label_rec_points: "Recorded points",
      label_rec_time: "Elapsed time",
      label_rec_distance: "Total distance (m)",
      label_ra: "rot alpha",
      label_rb: "rot beta",
      label_rg: "rot gamma",
      label_cHead: "compassHeading (¬∞)",
      label_cAcc: "compassAccuracy (¬∞)",
      label_ax: "acc x",
      label_ay: "acc y",
      label_az: "acc z",
      label_agx: "acc+g x",
      label_agy: "acc+g y",
      label_agz: "acc+g z",
      label_gforce: "G-Force (g)",
      desc_lat: "Latitude in decimal degrees (N/S).",
      desc_lon: "Longitude in decimal degrees (E/W).",
      desc_alt: "GPS-estimated altitude above sea level.",
      desc_hacc: "Estimated horizontal accuracy (lower is better).",
      desc_vacc: "Estimated vertical/altitude accuracy.",
      desc_sigq: "Simple rating for GPS signal quality.",
      desc_bearing: "Direction of travel in degrees (0¬∞ = North).",
      desc_bearing_src: "Bearing source: GPS or compass.",
      desc_speed: "Estimated current speed (km/h).",
      desc_ts: "Time of the last GPS fix.",
      desc_dtGps: "Time between the current and previous fix (ms).",
      desc_updateAge: "How long since the last fix (s).",
      desc_dLast: "Distance traveled since the last fix (m).",
      desc_dTot: "Total accumulated distance since start (m).",
      desc_vAvg: "Average speed since first fix (km/h).",
      desc_vMax: "Highest recorded speed (km/h).",
      desc_dAlt: "Altitude change between two fixes (m).",
      desc_vVert: "Estimated vertical speed (m/s).",
      desc_pace: "Estimated pace per kilometer (min/km).",
      desc_ra: "Device rotation around Z axis (alpha).",
      desc_rb: "Device rotation around X axis (beta).",
      desc_rg: "Device rotation around Y axis (gamma).",
      desc_cHead: "Device compass heading in degrees.",
      desc_cAcc: "Compass accuracy in degrees.",
      desc_ax: "Acceleration without gravity on X axis (m/s¬≤).",
      desc_ay: "Acceleration without gravity on Y axis (m/s¬≤).",
      desc_az: "Acceleration without gravity on Z axis (m/s¬≤).",
      desc_agx: "Acceleration including gravity on X axis (m/s¬≤).",
      desc_agy: "Acceleration including gravity on Y axis (m/s¬≤).",
      desc_agz: "Acceleration including gravity on Z axis (m/s¬≤).",
      desc_gforce: "Acceleration magnitude in G units.",
      btn_rec_start: "Start recording",
      btn_rec_pause: "Pause",
      btn_rec_resume: "Resume",
      btn_rec_stop: "Stop & Download GPX",
      btn_rec_reset: "Reset",
      btn_maps: "Open in Google Maps",
      btn_retry_geo: "Try again",
      geo_perm_title: "Location permission denied",
      geo_perm_explain: "On Android, if location is denied the first time, the browser won't prompt again automatically.",
      geo_perm_steps_title: "Chrome (Android):",
      geo_perm_step1: "Tap the üîí icon next to the address bar",
      geo_perm_step2: "Go to Permissions",
      geo_perm_step3: "Enable Location",
      geo_perm_step4: "Reload the page",
      geo_perm_retry_note: "Only works if the browser still allows a new prompt.",
      gps_update_note: "The GPS update rate is controlled by the operating system and browser. The Web API does not guarantee a fixed update rate (e.g., 1 Hz).",
      geo_instruction: "Enable location access in your browser permissions.",
      geo_status_denied: "Location permission denied",
      rec_status_recording: "Recording",
      rec_status_paused: "Paused",
      rec_status_stopped: "Stopped",
      rec_status_error_perm: "Error: permission denied",
      rec_status_error_unavailable: "Error: GPS unavailable",
      rec_status_error_timeout: "Error: timeout",
      rec_status_error_no_geo: "Error: GPS not supported",
      rec_status_no_points: "No points to export",
      info_label: "Show explanation",
      sig_excellent: "Excellent",
      sig_good: "Good",
      sig_bad: "Poor",
      sig_poor: "Very poor",
      bearing_gps: "GPS",
      bearing_compass: "Compass",
    },
    es: {
      start_btn: "Iniciar (pedir permisos)",
      section_gps: "GPS / Fix",
      section_telemetry: "Telemetr√≠a",
      section_gpx_recording: "Grabaci√≥n",
      section_elevation: "Elevaci√≥n",
      label_activity_name: "Nombre de la actividad",
      label_activity_note: "Observaci√≥n",
      placeholder_activity_name: "Ej: Carrera en el parque",
      placeholder_activity_note: "Ej: Subidas fuertes a mitad.",
      label_gain: "Ganancia acumulada (m)",
      label_loss: "P√©rdida acumulada (m)",
      label_grade: "Pendiente √∫ltimo tramo (%)",
      label_profile: "Perfil altim√©trico",
      section_orientation: "Orientaci√≥n",
      section_motion: "Movimiento",
      label_lat: "Latitud",
      label_lat_dms: "Lat (DMS)",
      label_lon: "Longitud",
      label_lon_dms: "Lon (DMS)",
      label_geo_status: "Estado GPS",
      label_alt: "Altitud (m)",
      label_hacc: "Acc H (m)",
      label_vacc: "Acc Alt (m)",
      label_sigq: "Calidad de se√±al",
      label_bearing: "Rumbo (¬∞)",
      label_bearing_src: "Fuente del rumbo",
      label_speed: "Velocidad (km/h)",
      label_ts: "Timestamp",
      label_dtGps: "Œît GPS (ms)",
      label_updateAge: "Actualizaci√≥n (s)",
      label_dLast: "Dist. entre actualizaciones (m)",
      label_dTot: "Distancia total (m)",
      label_vAvg: "Vel. media",
      label_vMax: "Vel. m√°x (km/h)",
      label_dAlt: "Œî Altitud (m)",
      label_vVert: "Vel. vertical (m/s)",
      label_pace: "Ritmo (min/km)",
      label_rec_status: "Estado",
      label_rec_points: "Puntos grabados",
      label_rec_time: "Tiempo transcurrido",
      label_rec_distance: "Distancia total (m)",
      label_ra: "rot alpha",
      label_rb: "rot beta",
      label_rg: "rot gamma",
      label_cHead: "compassHeading (¬∞)",
      label_cAcc: "compassAccuracy (¬∞)",
      label_ax: "acc x",
      label_ay: "acc y",
      label_az: "acc z",
      label_agx: "acc+g x",
      label_agy: "acc+g y",
      label_agz: "acc+g z",
      label_gforce: "G-Force (g)",
      desc_lat: "Latitud en grados decimales (N/S).",
      desc_lon: "Longitud en grados decimales (E/O).",
      desc_alt: "Altitud estimada por GPS sobre el nivel del mar.",
      desc_hacc: "Precisi√≥n horizontal estimada (menor es mejor).",
      desc_vacc: "Precisi√≥n vertical/altitud estimada.",
      desc_sigq: "Calificaci√≥n simple de la se√±al GPS.",
      desc_bearing: "Direcci√≥n de desplazamiento en grados (0¬∞ = Norte).",
      desc_bearing_src: "Fuente del rumbo: GPS o br√∫jula.",
      desc_speed: "Velocidad actual estimada (km/h).",
      desc_ts: "Hora del √∫ltimo fix de GPS.",
      desc_dtGps: "Tiempo entre el fix actual y el anterior (ms).",
      desc_updateAge: "Tiempo desde el √∫ltimo fix (s).",
      desc_dLast: "Distancia recorrida desde el √∫ltimo fix (m).",
      desc_dTot: "Distancia total acumulada desde el inicio (m).",
      desc_vAvg: "Velocidad media desde el primer fix (km/h).",
      desc_vMax: "Mayor velocidad registrada (km/h).",
      desc_dAlt: "Cambio de altitud entre fixes (m).",
      desc_vVert: "Velocidad vertical estimada (m/s).",
      desc_pace: "Ritmo estimado por kil√≥metro (min/km).",
      desc_ra: "Rotaci√≥n del dispositivo en el eje Z (alpha).",
      desc_rb: "Rotaci√≥n del dispositivo en el eje X (beta).",
      desc_rg: "Rotaci√≥n del dispositivo en el eje Y (gamma).",
      desc_cHead: "Rumbo de la br√∫jula del dispositivo en grados.",
      desc_cAcc: "Precisi√≥n de la br√∫jula en grados.",
      desc_ax: "Aceleraci√≥n sin gravedad en el eje X (m/s¬≤).",
      desc_ay: "Aceleraci√≥n sin gravedad en el eje Y (m/s¬≤).",
      desc_az: "Aceleraci√≥n sin gravedad en el eje Z (m/s¬≤).",
      desc_agx: "Aceleraci√≥n con gravedad en el eje X (m/s¬≤).",
      desc_agy: "Aceleraci√≥n con gravedad en el eje Y (m/s¬≤).",
      desc_agz: "Aceleraci√≥n con gravedad en el eje Z (m/s¬≤).",
      desc_gforce: "Magnitud de la aceleraci√≥n en unidades G.",
      btn_rec_start: "Iniciar grabaci√≥n",
      btn_rec_pause: "Pausar",
      btn_rec_resume: "Reanudar",
      btn_rec_stop: "Detener y bajar GPX",
      btn_rec_reset: "Reset",
      btn_maps: "Abrir en Google Maps",
      btn_retry_geo: "Intentar de nuevo",
      geo_perm_title: "Permiso de ubicaci√≥n denegado",
      geo_perm_explain: "En Android, si la ubicaci√≥n se niega la primera vez, el navegador no vuelve a preguntar autom√°ticamente.",
      geo_perm_steps_title: "Chrome (Android):",
      geo_perm_step1: "Toque el √≠cono üîí junto a la barra de direcciones",
      geo_perm_step2: "Vaya a Permisos",
      geo_perm_step3: "Active Ubicaci√≥n",
      geo_perm_step4: "Recargue la p√°gina",
      geo_perm_retry_note: "Solo funciona si el navegador a√∫n permite un nuevo aviso.",
      gps_update_note: "La tasa de actualizaci√≥n del GPS la controla el sistema operativo y el navegador. La Web API no garantiza una tasa fija (ej.: 1 Hz).",
      geo_instruction: "Active la ubicaci√≥n en los permisos del navegador.",
      geo_status_denied: "Permiso de ubicaci√≥n denegado",
      rec_status_recording: "Grabando",
      rec_status_paused: "Pausado",
      rec_status_stopped: "Detenido",
      rec_status_error_perm: "Error: permiso denegado",
      rec_status_error_unavailable: "Error: GPS no disponible",
      rec_status_error_timeout: "Error: tiempo de espera",
      rec_status_error_no_geo: "Error: GPS no soportado",
      rec_status_no_points: "Sin puntos para exportar",
      info_label: "Mostrar explicaci√≥n",
      sig_excellent: "Excelente",
      sig_good: "Buena",
      sig_bad: "Mala",
      sig_poor: "Muy mala",
      bearing_gps: "GPS",
      bearing_compass: "Br√∫jula",
    },
  };

  const localeMap = { pt: "pt-BR", en: "en-US", es: "es-ES" };
  let currentLang = "pt";

  function t(key) {
    return translations[currentLang]?.[key] ?? translations.pt[key] ?? key;
  }

  function applyTranslations() {
    document.documentElement.lang = currentLang === "pt" ? "pt-br" : currentLang;
    document.querySelectorAll("[data-i18n]").forEach((el) => {
      const key = el.dataset.i18n;
      const text = t(key);
      if (text) el.textContent = text;
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
      const key = el.dataset.i18nPlaceholder;
      const text = t(key);
      if (text) el.setAttribute("placeholder", text);
    });

    document.querySelectorAll(".info-btn").forEach((btn) => {
      const label = t("info_label");
      btn.setAttribute("aria-label", label);
      btn.setAttribute("title", label);
      if (!btn.hasAttribute("aria-expanded")) {
        btn.setAttribute("aria-expanded", "false");
      }
    });

    setRecordingStatus(recordingStatusKey);
  }

  function isEmptyValue(val){
    return val == null || val === "" || val === "‚Äî";
  }

  function formatPace(speedMs){
    if (typeof speedMs !== "number" || !isFinite(speedMs) || speedMs <= 0) return null;
    const totalSeconds = 1000 / speedMs;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.round(totalSeconds % 60);
    return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
  }

  function formatDms(value, isLat){
    if (typeof value !== "number" || !isFinite(value)) return null;
    const dir = value >= 0 ? (isLat ? "N" : "E") : (isLat ? "S" : "W");
    const abs = Math.abs(value);
    const totalSeconds = abs * 3600;
    let degrees = Math.floor(totalSeconds / 3600);
    let minutes = Math.floor((totalSeconds - degrees * 3600) / 60);
    let seconds = totalSeconds - degrees * 3600 - minutes * 60;
    seconds = Number(seconds.toFixed(1));
    if (seconds >= 60) {
      seconds = 0;
      minutes += 1;
    }
    if (minutes >= 60) {
      minutes = 0;
      degrees += 1;
    }
    const minutesText = String(minutes).padStart(2, "0");
    const secondsText = seconds.toFixed(1).padStart(4, "0");
    return `${degrees}¬∞ ${minutesText}' ${secondsText}" ${dir}`;
  }

  function signalQualityFromAccuracy(acc){
    if (typeof acc !== "number" || !isFinite(acc)) return null;
    if (acc <= 10) return t("sig_excellent");
    if (acc <= 30) return t("sig_good");
    if (acc <= 100) return t("sig_bad");
    return t("sig_poor");
  }

  function updateSectionVisibility(card){
    if (!card) return;
    const rows = Array.from(card.querySelectorAll(".row"));
    const hasVisible = rows.some((row) => !row.classList.contains("hidden"));
    card.classList.toggle("hidden", !hasVisible);
  }

  function refreshLocalizedFields(){
    if (!lastPos) return;
    const c = lastPos.coords;
    setField("sigQ", signalQualityFromAccuracy(c.accuracy));
    const gpsHeading = (c.heading == null || c.heading < 0) ? null : c.heading;
    const compassHeading = (typeof lastCompassHeading === "number") ? lastCompassHeading : null;
    const bearingSource = gpsHeading != null ? t("bearing_gps") : (compassHeading != null ? t("bearing_compass") : null);
    setField("bearingSrc", bearingSource);
    const ts = new Date(lastPos.timestamp);
    setField("ts", ts.toLocaleTimeString(localeMap[currentLang] || "pt-BR"));
    if (geoPermissionState) {
      updateGeoPermissionUI(geoPermissionState);
    }
  }

  function setField(id, value){
    const el = $(id);
    if (!el) return;
    const row = el.closest(".row");
    if (isEmptyValue(value)){
      el.textContent = "‚Äî";
      if (row && !geoDeniedUI) row.classList.add("hidden");
    } else {
      el.textContent = value;
      if (row) row.classList.remove("hidden");
    }
    updateSectionVisibility(row ? row.closest(".card") : null);
  }

  function updateMapsLink(lat, lon){
    const row = $("mapsRow");
    const link = $("mapsLink");
    if (!row || !link) return;
    const valid = typeof lat === "number" && isFinite(lat) && typeof lon === "number" && isFinite(lon);
    if (valid) {
      link.href = `https://www.google.com/maps?q=${lat},${lon}`;
      row.classList.remove("hidden");
    } else {
      link.removeAttribute("href");
      row.classList.add("hidden");
    }
    updateSectionVisibility(row.closest(".card"));
  }

  function applyGeoDeniedPlaceholders(){
    lastPos = null;
    distTotal = 0;
    vmax = 0;
    t0 = null;
    elevationPoints = [];
    elevationDistance = 0;
    elevationGain = 0;
    elevationLoss = 0;
    elevationWindow = [];
    lastElevationPoint = null;
    lastElevationGrade = null;
    [
      "lat",
      "latDms",
      "lon",
      "lonDms",
      "alt",
      "hacc",
      "vacc",
      "sigQ",
      "bearing",
      "bearingSrc",
      "spd",
      "ts",
      "dtGps",
      "updateAge",
      "dLast",
      "dTot",
      "vAvg",
      "vMax",
      "dAlt",
      "vVert",
      "pace",
      "recPoints",
      "recTime",
      "recDistance",
      "elevGain",
      "elevLoss",
    ].forEach((id) => setField(id, null));

    const elevGrade = $("elevGrade");
    if (elevGrade) {
      elevGrade.textContent = "‚Äî";
      const row = elevGrade.closest(".row");
      if (row) row.classList.remove("hidden");
    }

    updateMapsLink(null, null);
    drawElevationChart();
  }

  function updateGeoPermissionUI(state){
    const instruction = $("geoInstruction");
    const permissionCard = $("geoPermissionCard");
    geoPermissionState = state || null;
    geoDeniedUI = state === "denied";
    if (geoDeniedUI) {
      setField("geoStatus", t("geo_status_denied"));
      permissionCard?.classList.remove("hidden");
      instruction?.classList.add("hidden");
      applyGeoDeniedPlaceholders();
      stopGeo();
    } else {
      setField("geoStatus", null);
      permissionCard?.classList.add("hidden");
      instruction?.classList.add("hidden");
      if (state === "granted") {
        startGeo();
      }
    }
  }

  // Haversine distance in meters
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const toRad = (x) => x * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  function formatElapsed(ms){
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
  }

  function escapeXml(value){
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&apos;");
  }

  function buildGpx(points){
    const nameValue = $("activityName")?.value?.trim();
    const noteValue = $("activityNote")?.value?.trim();
    const lines = [
      '<?xml version="1.0" encoding="UTF-8"?>',
      '<gpx version="1.1" creator="GPS-DATA" xmlns="http://www.topografix.com/GPX/1/1">',
      '  <trk>',
      `    <name>${escapeXml(nameValue || "GPS-DATA Track")}</name>`,
    ];
    if (noteValue) {
      lines.push(`    <desc>${escapeXml(noteValue)}</desc>`);
      lines.push(`    <cmt>${escapeXml(noteValue)}</cmt>`);
    }
    lines.push(
      '    <trkseg>',
    );
    points.forEach((pt) => {
      const lat = Number(pt.lat).toFixed(6);
      const lon = Number(pt.lon).toFixed(6);
      lines.push(`      <trkpt lat="${escapeXml(lat)}" lon="${escapeXml(lon)}">`);
      if (typeof pt.ele === "number" && isFinite(pt.ele)) {
        lines.push(`        <ele>${escapeXml(pt.ele.toFixed(1))}</ele>`);
      }
      if (pt.time) {
        lines.push(`        <time>${escapeXml(new Date(pt.time).toISOString())}</time>`);
      }
      lines.push("      </trkpt>");
    });
    lines.push("    </trkseg>", "  </trk>", "</gpx>");
    return lines.join("\n");
  }

  function buildFileName(){
    const now = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    return `track-${stamp}.gpx`;
  }

  function downloadGpx(content){
    const blob = new Blob([content], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = buildFileName();
    link.rel = "noopener";
    link.style.display = "none";
    document.body.appendChild(link);
    link.click();
    requestAnimationFrame(() => {
      URL.revokeObjectURL(url);
      link.remove();
    });
  }

  function loadActivityMetadata(){
    const nameInput = $("activityName");
    const noteInput = $("activityNote");
    if (nameInput) {
      const savedName = localStorage.getItem(STORAGE_KEYS.activityName);
      if (savedName != null) nameInput.value = savedName;
    }
    if (noteInput) {
      const savedNote = localStorage.getItem(STORAGE_KEYS.activityNote);
      if (savedNote != null) noteInput.value = savedNote;
    }
  }

  function saveActivityMetadata(){
    const nameInput = $("activityName");
    const noteInput = $("activityNote");
    if (nameInput) {
      localStorage.setItem(STORAGE_KEYS.activityName, nameInput.value.trim());
    }
    if (noteInput) {
      localStorage.setItem(STORAGE_KEYS.activityNote, noteInput.value.trim());
    }
  }

  // ---------- GEO ----------
  let watchId = null;
  let lastPos = null;
  let distTotal = 0;
  let vmax = 0;
  let t0 = null;
  let lastCompassHeading = null;
  let geoPermissionState = null;
  let geoDeniedUI = false;
  let recordingState = "stopped";
  let recordingStatusKey = "rec_status_stopped";
  let recordPoints = [];
  let recordDistance = 0;
  let recordStartTime = null;
  let recordElapsed = 0;
  let lastRecordedPoint = null;
  let elevationPoints = [];
  let elevationDistance = 0;
  let elevationGain = 0;
  let elevationLoss = 0;
  let elevationWindow = [];
  let lastElevationPoint = null;
  let lastElevationGrade = null;

  const STORAGE_KEYS = {
    activityName: "gps-data-activity-name",
    activityNote: "gps-data-activity-note",
  };

  function handlePosition(pos){
    const c = pos.coords;

    setField("lat", fmt(c.latitude, 6));
    setField("latDms", formatDms(c.latitude, true));
    setField("lon", fmt(c.longitude, 6));
    setField("lonDms", formatDms(c.longitude, false));
    setField("alt", fmt1(c.altitude));
    setField("hacc", fmt0(c.accuracy));
    setField("vacc", fmt0(c.altitudeAccuracy));
    setField("sigQ", signalQualityFromAccuracy(c.accuracy));
    updateMapsLink(c.latitude, c.longitude);
    updateGeoPermissionUI("granted");

    const spd = (c.speed == null || c.speed < 0) ? null : c.speed * 3.6;
    setField("spd", spd == null ? null : fmt1(spd));
    if (spd != null) vmax = Math.max(vmax, spd);
    setField("vMax", fmt1(vmax));

    const gpsHeading = (c.heading == null || c.heading < 0) ? null : c.heading;
    const compassHeading = (typeof lastCompassHeading === "number") ? lastCompassHeading : null;
    const bearing = gpsHeading != null ? gpsHeading : compassHeading;
    setField("bearing", bearing == null ? null : fmt0(bearing));
    const bearingSource = gpsHeading != null ? t("bearing_gps") : (compassHeading != null ? t("bearing_compass") : null);
    setField("bearingSrc", bearingSource);

    const ts = new Date(pos.timestamp);
    setField("ts", ts.toLocaleTimeString(localeMap[currentLang] || "pt-BR"));

    // dt + hz
    if (lastPos){
      const dt = pos.timestamp - lastPos.timestamp;
      setField("dtGps", dt > 0 ? fmt0(dt) : null);

      const d = haversine(lastPos.coords.latitude, lastPos.coords.longitude, c.latitude, c.longitude);
      setField("dLast", fmt1(d));
      distTotal += d;
      setField("dTot", fmt1(distTotal));

      const lastAlt = lastPos.coords.altitude;
      const deltaAlt = (typeof c.altitude === "number" && typeof lastAlt === "number") ? (c.altitude - lastAlt) : null;
      setField("dAlt", deltaAlt == null ? null : fmt1(deltaAlt));
      const dtSec = dt / 1000;
      const vVert = (deltaAlt == null || !dtSec || dtSec <= 0) ? null : (deltaAlt / dtSec);
      setField("vVert", vVert == null ? null : fmt1(vVert));
    } else {
      setField("dtGps", null);
      setField("dLast", null);
      setField("dTot", fmt1(distTotal));
      setField("dAlt", null);
      setField("vVert", null);
    }

    // avg speed since first fix (by distance/time)
    if (!t0) t0 = pos.timestamp;
    const dtTotal = (pos.timestamp - t0) / 1000;
    if (dtTotal > 0){
      const vavg = (distTotal / dtTotal) * 3.6;
      setField("vAvg", fmt1(vavg));
    } else {
      setField("vAvg", null);
    }

    setField("pace", formatPace(c.speed));

    lastPos = pos;

    handleRecordingPoint(pos);
  }

  function handleGeoError(err){
    console.warn("Geolocation error", err);
    if (!err || typeof err.code !== "number") return;
    if (err.code === 1) {
      setRecordingStatus("rec_status_error_perm");
      updateGeoPermissionUI("denied");
    } else if (err.code === 2) {
      setRecordingStatus("rec_status_error_unavailable");
    } else if (err.code === 3) {
      setRecordingStatus("rec_status_error_timeout");
    }
    stopRecording(true);
  }

  async function initGeoPermissions(){
    if (!navigator.permissions || !navigator.permissions.query) return;
    try {
      const status = await navigator.permissions.query({ name: "geolocation" });
      geoPermissionState = status.state;
      updateGeoPermissionUI(status.state);
      status.onchange = () => {
        geoPermissionState = status.state;
        updateGeoPermissionUI(status.state);
      };
    } catch (e) {
      console.warn("Permissions query error", e);
    }
  }

  function startGeo(){
    if (!navigator.geolocation) { return; }
    if (watchId != null) { return; }

    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
    watchId = navigator.geolocation.watchPosition(handlePosition, handleGeoError, opts);
  }

  function stopGeo(){
    if (watchId != null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
  }

  function retryGeolocation(){
    if (!navigator.geolocation) {
      setRecordingStatus("rec_status_error_no_geo");
      return;
    }
    stopGeo();
    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        handlePosition(pos);
        startGeo();
      },
      (err) => {
        handleGeoError(err);
      },
      opts
    );
  }

  function currentElapsedMs(){
    if (recordingState === "recording" && recordStartTime) {
      return recordElapsed + (Date.now() - recordStartTime);
    }
    return recordElapsed;
  }

  function updateRecordingStats(){
    if (geoDeniedUI) {
      setField("recPoints", null);
      setField("recTime", null);
      setField("recDistance", null);
      return;
    }
    setField("recPoints", String(recordPoints.length));
    setField("recTime", formatElapsed(currentElapsedMs()));
    setField("recDistance", fmt1(recordDistance) ?? "0.0");
  }

  function updateElevationStats(){
    if (geoDeniedUI) {
      setField("elevGain", null);
      setField("elevLoss", null);
      const gradeEl = $("elevGrade");
      if (gradeEl) {
        gradeEl.textContent = "‚Äî";
        const row = gradeEl.closest(".row");
        if (row) row.classList.remove("hidden");
      }
      return;
    }
    setField("elevGain", fmt1(elevationGain) ?? "0.0");
    setField("elevLoss", fmt1(elevationLoss) ?? "0.0");
    const gradeEl = $("elevGrade");
    if (gradeEl) {
      gradeEl.textContent = lastElevationGrade == null ? "‚Äî" : fmt1(lastElevationGrade);
      const row = gradeEl.closest(".row");
      if (row) row.classList.remove("hidden");
      updateSectionVisibility(row ? row.closest(".card") : null);
    }
  }

  function setRecordingStatus(key){
    if (!key) return;
    recordingStatusKey = key;
    setField("recStatus", t(key));
  }

  function updateRecordingControls(){
    const startBtn = $("recStartBtn");
    const pauseBtn = $("recPauseBtn");
    const resumeBtn = $("recResumeBtn");
    const stopBtn = $("recStopBtn");
    const resetBtn = $("recResetBtn");
    if (!startBtn || !pauseBtn || !resumeBtn || !stopBtn || !resetBtn) return;

    startBtn.disabled = recordingState !== "stopped";
    pauseBtn.disabled = recordingState !== "recording";
    resumeBtn.disabled = recordingState !== "paused";
    stopBtn.disabled = recordingState === "stopped";
    resetBtn.disabled = recordingState !== "stopped";
  }

  function resetRecordingData(){
    recordPoints = [];
    recordDistance = 0;
    recordStartTime = null;
    recordElapsed = 0;
    lastRecordedPoint = null;
    elevationPoints = [];
    elevationDistance = 0;
    elevationGain = 0;
    elevationLoss = 0;
    elevationWindow = [];
    lastElevationPoint = null;
    lastElevationGrade = null;
    updateRecordingStats();
    updateElevationStats();
    drawElevationChart();
  }

  function handleRecordingPoint(pos){
    if (recordingState !== "recording") return;
    const c = pos.coords;
    if (typeof c.latitude !== "number" || typeof c.longitude !== "number") return;

    const point = {
      lat: c.latitude,
      lon: c.longitude,
      time: pos.timestamp,
    };
    if (typeof c.altitude === "number") {
      point.ele = c.altitude;
    }
    if (typeof c.speed === "number" && c.speed >= 0) {
      point.speed = c.speed;
    }
    if (typeof c.heading === "number" && c.heading >= 0) {
      point.heading = c.heading;
    }

    if (lastRecordedPoint) {
      recordDistance += haversine(
        lastRecordedPoint.lat,
        lastRecordedPoint.lon,
        point.lat,
        point.lon
      );
    }

    lastRecordedPoint = point;
    recordPoints.push(point);
    updateRecordingStats();
    updateElevationFromPoint(pos);
  }

  function updateElevationFromPoint(pos){
    const c = pos.coords;
    if (typeof c.altitude !== "number" || !isFinite(c.altitude)) return;
    const hasAccuracy = typeof c.accuracy === "number" && isFinite(c.accuracy);
    if (!hasAccuracy || c.accuracy > 50) return;
    if (typeof c.latitude !== "number" || typeof c.longitude !== "number") return;

    const rawAlt = c.altitude;
    elevationWindow.push(rawAlt);
    if (elevationWindow.length > 5) elevationWindow.shift();
    const smoothAlt = elevationWindow.reduce((sum, val) => sum + val, 0) / elevationWindow.length;

    if (!lastElevationPoint) {
      lastElevationPoint = { lat: c.latitude, lon: c.longitude, alt: smoothAlt };
      elevationPoints.push({ d: 0, alt: smoothAlt });
      updateElevationStats();
      drawElevationChart();
      return;
    }

    const segmentDistance = haversine(
      lastElevationPoint.lat,
      lastElevationPoint.lon,
      c.latitude,
      c.longitude
    );
    if (segmentDistance < 3) return;

    elevationDistance += segmentDistance;
    const deltaAlt = smoothAlt - lastElevationPoint.alt;
    if (deltaAlt > 0) {
      elevationGain += deltaAlt;
    } else if (deltaAlt < 0) {
      elevationLoss += Math.abs(deltaAlt);
    }
    lastElevationGrade = (segmentDistance > 0) ? (deltaAlt / segmentDistance) * 100 : null;
    lastElevationPoint = { lat: c.latitude, lon: c.longitude, alt: smoothAlt };
    elevationPoints.push({ d: elevationDistance, alt: smoothAlt });
    updateElevationStats();
    drawElevationChart();
  }

  function drawElevationChart(){
    const canvas = $("elevChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const width = canvas.clientWidth || 600;
    const height = canvas.clientHeight || 180;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = width * dpr;
    canvas.height = height * dpr;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);

    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = "#0b1124";
    ctx.fillRect(0, 0, width, height);

    if (!elevationPoints.length) {
      ctx.fillStyle = "#aeb4c8";
      ctx.font = "12px -apple-system, system-ui, Segoe UI, Arial";
      ctx.fillText(t("label_profile"), 10, 20);
      return;
    }

    const padding = { top: 10, right: 10, bottom: 24, left: 36 };
    const plotW = width - padding.left - padding.right;
    const plotH = height - padding.top - padding.bottom;

    const altitudes = elevationPoints.map((p) => p.alt);
    const minAlt = Math.min(...altitudes);
    const maxAlt = Math.max(...altitudes);
    const altRange = Math.max(1, maxAlt - minAlt);
    const maxDist = Math.max(1, elevationPoints[elevationPoints.length - 1].d);

    ctx.strokeStyle = "#1f2b52";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top);
    ctx.lineTo(padding.left, height - padding.bottom);
    ctx.lineTo(width - padding.right, height - padding.bottom);
    ctx.stroke();

    ctx.strokeStyle = "#4b5aa8";
    ctx.lineWidth = 2;
    ctx.beginPath();
    elevationPoints.forEach((p, idx) => {
      const x = padding.left + (p.d / maxDist) * plotW;
      const y = padding.top + (1 - (p.alt - minAlt) / altRange) * plotH;
      if (idx === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.stroke();

    ctx.fillStyle = "#cbd1e6";
    ctx.font = "11px -apple-system, system-ui, Segoe UI, Arial";
    ctx.fillText(`${minAlt.toFixed(0)}m`, padding.left, height - 6);
    ctx.fillText(`${maxAlt.toFixed(0)}m`, padding.left, padding.top + 12);
    ctx.fillText(`${maxDist.toFixed(0)}m`, width - padding.right - 40, height - 6);
  }

  function startRecording(){
    if (!navigator.geolocation) {
      setRecordingStatus("rec_status_error_no_geo");
      return;
    }
    if (recordingState === "recording") return;
    if (recordingState === "stopped") {
      resetRecordingData();
    }
    recordingState = "recording";
    recordStartTime = Date.now();
    setRecordingStatus("rec_status_recording");
    updateRecordingControls();
    startGeo();
  }

  function pauseRecording(){
    if (recordingState !== "recording") return;
    recordElapsed = currentElapsedMs();
    recordStartTime = null;
    recordingState = "paused";
    setRecordingStatus("rec_status_paused");
    updateRecordingControls();
  }

  function resumeRecording(){
    if (recordingState !== "paused") return;
    recordStartTime = Date.now();
    recordingState = "recording";
    setRecordingStatus("rec_status_recording");
    updateRecordingControls();
  }

  function stopRecording(fromError = false){
    if (recordingState === "stopped") return;
    recordElapsed = currentElapsedMs();
    recordStartTime = null;
    recordingState = "stopped";
    if (!fromError) {
      setRecordingStatus("rec_status_stopped");
    }
    updateRecordingControls();
    stopGeo();
    updateRecordingStats();
  }

  function stopAndDownload(){
    if (recordingState !== "recording" && recordingState !== "paused") return;
    stopRecording();
    if (!recordPoints.length) {
      setRecordingStatus("rec_status_no_points");
      return;
    }
    const gpxContent = buildGpx(recordPoints);
    downloadGpx(gpxContent);
  }

  // update age
  setInterval(()=>{
    if (geoDeniedUI || !lastPos) { setField("updateAge", null); return; }
    setField("updateAge", fmt1((Date.now() - lastPos.timestamp)/1000));
  }, 200);

  setInterval(()=>{
    updateRecordingStats();
  }, 500);

  // ---------- ORIENTATION ----------
  async function startOrientation(){
    try {
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") { return; }
      }
      window.addEventListener("deviceorientation", (e)=>{
        // iOS-specific (pode existir ou n√£o)
        const ch = e.webkitCompassHeading;
        const ca = e.webkitCompassAccuracy;
        lastCompassHeading = (typeof ch === "number") ? ch : null;
        setField("cHead", (typeof ch === "number") ? fmt0(ch) : null);
        setField("cAcc", (typeof ca === "number") ? fmt0(ca) : null);
      }, true);

    } catch (e) {
      console.warn("Orientation error", e);
    }
  }

  // ---------- MOTION ----------
  async function startMotion(){
    try {
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") { return; }
      }

      window.addEventListener("devicemotion", (e)=>{
        const a = e.acceleration || {};
        const ag = e.accelerationIncludingGravity || {};
        const r = e.rotationRate || {};

        setField("ax", a.x == null ? null : fmt1(a.x));
        setField("ay", a.y == null ? null : fmt1(a.y));
        setField("az", a.z == null ? null : fmt1(a.z));

        setField("agx", ag.x == null ? null : fmt1(ag.x));
        setField("agy", ag.y == null ? null : fmt1(ag.y));
        setField("agz", ag.z == null ? null : fmt1(ag.z));
        const gMag = (typeof ag.x === "number" && typeof ag.y === "number" && typeof ag.z === "number")
          ? Math.sqrt((ag.x ** 2) + (ag.y ** 2) + (ag.z ** 2)) / 9.81
          : null;
        setField("gforce", gMag == null ? null : fmt1(gMag));

        setField("ra", r.alpha == null ? null : fmt1(r.alpha));
        setField("rb", r.beta == null ? null : fmt1(r.beta));
        setField("rg", r.gamma == null ? null : fmt1(r.gamma));
      }, true);

    } catch (e) {
      console.warn("Motion error", e);
    }
  }

  // ---------- START ----------
  $("startBtn").addEventListener("click", async ()=>{
    await startOrientation();
    await startMotion();
  });

  $("recStartBtn").addEventListener("click", () => {
    startRecording();
  });

  $("recPauseBtn").addEventListener("click", () => {
    pauseRecording();
  });

  $("recResumeBtn").addEventListener("click", () => {
    resumeRecording();
  });

  $("recStopBtn").addEventListener("click", () => {
    stopAndDownload();
  });

  $("recResetBtn").addEventListener("click", () => {
    stopRecording();
    resetRecordingData();
    setRecordingStatus("rec_status_stopped");
    updateRecordingControls();
  });

  $("retryGeoBtn")?.addEventListener("click", () => {
    retryGeolocation();
    initGeoPermissions();
  });

  document.querySelectorAll(".lang-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const lang = btn.dataset.lang;
      if (!lang || lang === currentLang) return;
      currentLang = lang;
      document.querySelectorAll(".lang-btn").forEach((b) => {
        b.classList.toggle("active", b.dataset.lang === currentLang);
      });
      applyTranslations();
      refreshLocalizedFields();
    });
  });

  document.querySelectorAll(".info-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const row = btn.closest(".row");
      if (!row) return;
      const desc = row.querySelector(".desc");
      if (!desc) return;
      const isOpen = desc.classList.toggle("open");
      btn.setAttribute("aria-expanded", String(isOpen));
    });
  });

  $("activityName")?.addEventListener("input", saveActivityMetadata);
  $("activityNote")?.addEventListener("input", saveActivityMetadata);
  window.addEventListener("resize", drawElevationChart);

  applyTranslations();
  loadActivityMetadata();
  updateRecordingControls();
  updateRecordingStats();
  updateElevationStats();
  drawElevationChart();
  initGeoPermissions();

  document.querySelectorAll(".row").forEach((row)=>{
    if (row.hasAttribute("data-keep-visible")) {
      updateSectionVisibility(row.closest(".card"));
      return;
    }
    const value = row.querySelector(".v");
    if (value) {
      const text = value.textContent;
      if (isEmptyValue(text)) {
        row.classList.add("hidden");
      }
    }
    updateSectionVisibility(row.closest(".card"));
  });
</script>
</body>
</html>
