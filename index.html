<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raw Sensor Panel (iPhone Web)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0b10; color:#e9e9ef; font-family:-apple-system,system-ui,Segoe UI,Arial; }
    .wrap { padding:16px; max-width:560px; margin:0 auto; }
    .btn { width:100%; padding:12px 14px; border-radius:14px; border:1px solid #2a2a45; background:#1a1a2b; color:#fff; font-weight:800; }
    .btn:active{ transform:scale(.99); }
    .hint { margin-top:10px; font-size:12px; opacity:.75; line-height:1.35; }
    .card { margin:12px 0; background:#141423; border:1px solid #23233b; border-radius:16px; padding:14px; }
    .title { font-weight:800; opacity:.92; margin-bottom:10px; display:flex; justify-content:space-between; gap:10px; }
    .badge { font-size:12px; padding:3px 10px; border-radius:999px; border:1px solid #2a2a45; opacity:.9; }
    .row { display:flex; justify-content:space-between; gap:14px; padding:7px 0; border-bottom:1px solid #202038; }
    .row:last-child{ border-bottom:none; }
    .k { opacity:.72; }
    .v { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-variant-numeric:tabular-nums; text-align:right; }
    .small { font-size:12px; opacity:.72; margin-top:10px; line-height:1.35; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .muted { opacity:.65; }
  </style>
</head>
<body>
  <div class="wrap">
    <button class="btn" id="startBtn">Iniciar (pedir permissões)</button>
    <div class="hint">
      Abra em HTTPS. No iOS, orientação/movimento exigem clique para pedir permissão.
    </div>

    <div class="card">
      <div class="title">
        <span>Status</span>
        <span class="badge" id="secure">—</span>
      </div>
      <div class="row"><div class="k">Geolocation</div><div class="v" id="stGeo">—</div></div>
      <div class="row"><div class="k">Orientation</div><div class="v" id="stOri">—</div></div>
      <div class="row"><div class="k">Motion</div><div class="v" id="stMot">—</div></div>
      <div class="row"><div class="k">Battery API</div><div class="v" id="stBat">—</div></div>
      <div class="row"><div class="k">User-Agent</div><div class="v" id="ua" style="max-width:320px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">—</div></div>
    </div>

    <div class="card">
      <div class="title"><span>GPS / Fix (Geolocation)</span><span class="badge" id="fixQual">—</span></div>
      <div class="grid2">
        <div>
          <div class="row"><div class="k">Latitude</div><div class="v" id="lat">—</div></div>
          <div class="row"><div class="k">Longitude</div><div class="v" id="lon">—</div></div>
          <div class="row"><div class="k">Altitude (m)</div><div class="v" id="alt">—</div></div>
          <div class="row"><div class="k">Accuracy H (m)</div><div class="v" id="hacc">—</div></div>
          <div class="row"><div class="k">AltitudeAcc (m)</div><div class="v" id="vacc">—</div></div>
        </div>
        <div>
          <div class="row"><div class="k">Speed (km/h)</div><div class="v" id="spd">—</div></div>
          <div class="row"><div class="k">Heading (°)</div><div class="v" id="hdg">—</div></div>
          <div class="row"><div class="k">Timestamp</div><div class="v" id="ts">—</div></div>
          <div class="row"><div class="k">Idade (s)</div><div class="v" id="age">—</div></div>
          <div class="row"><div class="k">Fix #</div><div class="v" id="fixN">0</div></div>
        </div>
      </div>
      <div class="small muted">
        Campos do fix (altitude/speed/heading/altitudeAccuracy) podem vir “—” dependendo do sinal e se você está parado.
      </div>
    </div>

    <div class="card">
      <div class="title"><span>Telemetria derivada (do GPS)</span><span class="badge" id="hz">—</span></div>
      <div class="row"><div class="k">Δt último fix (ms)</div><div class="v" id="dt">—</div></div>
      <div class="row"><div class="k">Distância último passo (m)</div><div class="v" id="dLast">—</div></div>
      <div class="row"><div class="k">Distância total (m)</div><div class="v" id="dTot">—</div></div>
      <div class="row"><div class="k">Vel. média (km/h)</div><div class="v" id="vAvg">—</div></div>
      <div class="row"><div class="k">Vel. máx (km/h)</div><div class="v" id="vMax">—</div></div>
    </div>

    <div class="card">
      <div class="title"><span>Orientação (DeviceOrientation)</span><span class="badge" id="oriBadge">—</span></div>
      <div class="grid2">
        <div>
          <div class="row"><div class="k">alpha</div><div class="v" id="alpha">—</div></div>
          <div class="row"><div class="k">beta</div><div class="v" id="beta">—</div></div>
          <div class="row"><div class="k">gamma</div><div class="v" id="gamma">—</div></div>
        </div>
        <div>
          <div class="row"><div class="k">compassHeading (°)</div><div class="v" id="cHead">—</div></div>
          <div class="row"><div class="k">compassAccuracy (°)</div><div class="v" id="cAcc">—</div></div>
          <div class="row"><div class="k">absolute</div><div class="v" id="abs">—</div></div>
        </div>
      </div>
      <div class="small muted">
        iOS exige permissão por gesto para Orientation/Motion desde iOS 13.
      </div>
    </div>

    <div class="card">
      <div class="title"><span>Movimento (DeviceMotion)</span><span class="badge" id="motBadge">—</span></div>

      <div class="title" style="margin-top:2px;"><span style="font-size:13px;opacity:.8;">Aceleração (m/s²)</span><span class="badge" id="motInt">—</span></div>
      <div class="grid2">
        <div>
          <div class="row"><div class="k">acc x</div><div class="v" id="ax">—</div></div>
          <div class="row"><div class="k">acc y</div><div class="v" id="ay">—</div></div>
          <div class="row"><div class="k">acc z</div><div class="v" id="az">—</div></div>
        </div>
        <div>
          <div class="row"><div class="k">acc+g x</div><div class="v" id="agx">—</div></div>
          <div class="row"><div class="k">acc+g y</div><div class="v" id="agy">—</div></div>
          <div class="row"><div class="k">acc+g z</div><div class="v" id="agz">—</div></div>
        </div>
      </div>

      <div class="title" style="margin-top:12px;"><span style="font-size:13px;opacity:.8;">Rotação (°/s)</span><span class="badge">gyro</span></div>
      <div class="row"><div class="k">rot alpha</div><div class="v" id="ra">—</div></div>
      <div class="row"><div class="k">rot beta</div><div class="v" id="rb">—</div></div>
      <div class="row"><div class="k">rot gamma</div><div class="v" id="rg">—</div></div>
    </div>

    <div class="card">
      <div class="title"><span>Bateria (se o browser suportar)</span><span class="badge" id="batBadge">—</span></div>
      <div class="row"><div class="k">Level (%)</div><div class="v" id="batLvl">—</div></div>
      <div class="row"><div class="k">Charging</div><div class="v" id="batChg">—</div></div>
      <div class="row"><div class="k">Time to full (s)</div><div class="v" id="batFull">—</div></div>
      <div class="row"><div class="k">Time to empty (s)</div><div class="v" id="batEmpty">—</div></div>
      <div class="small muted">
        Battery API existe na web, mas nem todo browser (especialmente mobile) expõe.
      </div>
    </div>

    <div class="card">
      <div class="title"><span>Limites do “web no iPhone”</span><span class="badge">realidade</span></div>
      <div class="row"><div class="k">Magnetômetro X/Y/Z (Web Sensor)</div><div class="v">indisponível no Safari iOS</div></div>
      <div class="row"><div class="k">Barômetro (pressão/altitude relativa)</div><div class="v">indisponível no Safari iOS</div></div>
      <div class="small muted">
        Magnetometer API não tem suporte no Safari iOS.
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  $("ua").textContent = navigator.userAgent || "—";
  $("secure").textContent = (window.isSecureContext ? "HTTPS OK" : "SEM HTTPS");
  $("secure").style.opacity = window.isSecureContext ? "1" : ".75";

  function nfmt(n, d=6) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(d) : "—"; }
  function nfmt1(n) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(1) : "—"; }
  function nfmt0(n) { return (typeof n === "number" && isFinite(n)) ? String(Math.round(n)) : "—"; }

  function qualFromAcc(m){
    if (!(typeof m === "number" && isFinite(m))) return "—";
    if (m <= 10) return "Excelente";
    if (m <= 30) return "Boa";
    if (m <= 100) return "Ruim";
    return "Péssima";
  }

  // Haversine distance in meters
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const toRad = (x) => x * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  // ---------- GEO ----------
  let watchId = null;
  let lastPos = null;
  let lastTS = null;
  let fixCount = 0;

  let distTotal = 0;
  let vmax = 0;
  let t0 = null;

  function startGeo(){
    if (!navigator.geolocation) { $("stGeo").textContent = "não suportado"; return; }
    $("stGeo").textContent = "solicitando…";

    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };

    watchId = navigator.geolocation.watchPosition((pos)=>{
      fixCount++;
      $("fixN").textContent = String(fixCount);

      const c = pos.coords;

      $("lat").textContent = nfmt(c.latitude, 6);
      $("lon").textContent = nfmt(c.longitude, 6);
      $("alt").textContent = (c.altitude == null) ? "—" : nfmt1(c.altitude);
      $("hacc").textContent = (c.accuracy == null) ? "—" : nfmt0(c.accuracy);
      $("vacc").textContent = (c.altitudeAccuracy == null) ? "—" : nfmt0(c.altitudeAccuracy);

      const spd = (c.speed == null || c.speed < 0) ? null : c.speed * 3.6;
      $("spd").textContent = (spd == null) ? "—" : nfmt1(spd);
      if (spd != null) vmax = Math.max(vmax, spd);
      $("vMax").textContent = (fixCount < 1) ? "—" : nfmt1(vmax);

      const hdg = (c.heading == null || c.heading < 0) ? null : c.heading;
      $("hdg").textContent = (hdg == null) ? "—" : nfmt0(hdg);

      const ts = new Date(pos.timestamp);
      $("ts").textContent = ts.toLocaleTimeString();
      lastTS = pos.timestamp;

      // dt + hz
      if (lastPos){
        const dt = pos.timestamp - lastPos.timestamp;
        $("dt").textContent = (dt > 0) ? nfmt0(dt) : "—";
        const hz = dt > 0 ? (1000/dt) : null;
        $("hz").textContent = hz ? (nfmt1(hz) + " Hz") : "—";

        const d = haversine(lastPos.coords.latitude, lastPos.coords.longitude, c.latitude, c.longitude);
        $("dLast").textContent = nfmt1(d);
        distTotal += d;
        $("dTot").textContent = nfmt1(distTotal);
      } else {
        $("dt").textContent = "—";
        $("hz").textContent = "—";
        $("dLast").textContent = "—";
        $("dTot").textContent = nfmt1(distTotal);
      }

      // avg speed since first fix (by distance/time)
      if (!t0) t0 = pos.timestamp;
      const dtTotal = (pos.timestamp - t0) / 1000;
      if (dtTotal > 0){
        const vavg = (distTotal / dtTotal) * 3.6;
        $("vAvg").textContent = nfmt1(vavg);
      } else {
        $("vAvg").textContent = "—";
      }

      // fix quality badge
      const q = qualFromAcc(c.accuracy);
      $("fixQual").textContent = q;
      $("stGeo").textContent = "ok";
      lastPos = pos;

    }, (err)=>{
      $("stGeo").textContent = `erro (${err.code})`;
    }, opts);
  }

  // update age
  setInterval(()=>{
    if (!lastTS) { $("age").textContent = "—"; return; }
    $("age").textContent = nfmt1((Date.now() - lastTS)/1000);
  }, 200);

  // ---------- ORIENTATION ----------
  async function startOrientation(){
    $("stOri").textContent = "solicitando…";
    try {
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") { $("stOri").textContent = "negado"; $("oriBadge").textContent = "negado"; return; }
      }
      window.addEventListener("deviceorientation", (e)=>{
        $("alpha").textContent = (e.alpha==null) ? "—" : nfmt1(e.alpha);
        $("beta").textContent  = (e.beta==null)  ? "—" : nfmt1(e.beta);
        $("gamma").textContent = (e.gamma==null) ? "—" : nfmt1(e.gamma);
        $("abs").textContent = (e.absolute==null) ? "—" : String(!!e.absolute);

        // iOS-specific (pode existir ou não)
        const ch = e.webkitCompassHeading;
        const ca = e.webkitCompassAccuracy;
        $("cHead").textContent = (typeof ch === "number") ? nfmt0(ch) : "—";
        $("cAcc").textContent  = (typeof ca === "number") ? nfmt0(ca) : "—";

        $("stOri").textContent = "ok";
        $("oriBadge").textContent = "ativo";
      }, true);

    } catch (e) {
      $("stOri").textContent = "erro";
      $("oriBadge").textContent = "erro";
    }
  }

  // ---------- MOTION ----------
  async function startMotion(){
    $("stMot").textContent = "solicitando…";
    try {
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") { $("stMot").textContent = "negado"; $("motBadge").textContent = "negado"; return; }
      }

      window.addEventListener("devicemotion", (e)=>{
        const a = e.acceleration || {};
        const ag = e.accelerationIncludingGravity || {};
        const r = e.rotationRate || {};

        $("ax").textContent = (a.x==null) ? "—" : nfmt1(a.x);
        $("ay").textContent = (a.y==null) ? "—" : nfmt1(a.y);
        $("az").textContent = (a.z==null) ? "—" : nfmt1(a.z);

        $("agx").textContent = (ag.x==null) ? "—" : nfmt1(ag.x);
        $("agy").textContent = (ag.y==null) ? "—" : nfmt1(ag.y);
        $("agz").textContent = (ag.z==null) ? "—" : nfmt1(ag.z);

        $("ra").textContent = (r.alpha==null) ? "—" : nfmt1(r.alpha);
        $("rb").textContent = (r.beta==null)  ? "—" : nfmt1(r.beta);
        $("rg").textContent = (r.gamma==null) ? "—" : nfmt1(r.gamma);

        $("motInt").textContent = (typeof e.interval === "number") ? (nfmt0(e.interval) + " ms") : "—";

        $("stMot").textContent = "ok";
        $("motBadge").textContent = "ativo";
      }, true);

    } catch (e) {
      $("stMot").textContent = "erro";
      $("motBadge").textContent = "erro";
    }
  }

  // ---------- BATTERY ----------
  async function startBattery(){
    if (typeof navigator.getBattery !== "function") {
      $("stBat").textContent = "indisponível";
      $("batBadge").textContent = "—";
      return;
    }
    $("stBat").textContent = "ok";
    $("batBadge").textContent = "ativo";

    const bat = await navigator.getBattery();
    function render(){
      $("batLvl").textContent = (typeof bat.level === "number") ? nfmt0(bat.level*100) : "—";
      $("batChg").textContent = (typeof bat.charging === "boolean") ? String(bat.charging) : "—";
      $("batFull").textContent = (typeof bat.chargingTime === "number" && isFinite(bat.chargingTime)) ? nfmt0(bat.chargingTime) : "—";
      $("batEmpty").textContent = (typeof bat.dischargingTime === "number" && isFinite(bat.dischargingTime)) ? nfmt0(bat.dischargingTime) : "—";
    }
    render();
    bat.addEventListener("levelchange", render);
    bat.addEventListener("chargingchange", render);
    bat.addEventListener("chargingtimechange", render);
    bat.addEventListener("dischargingtimechange", render);
  }

  // ---------- START ----------
  $("startBtn").addEventListener("click", async ()=>{
    startGeo();
    await startOrientation();
    await startMotion();
    await startBattery();
  });
</script>
</body>
</html>
