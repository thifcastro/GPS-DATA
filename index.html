<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raw Sensor Panel (iPhone Web)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:linear-gradient(180deg,#1d3b8f 0%, #0f1d4f 70%, #0b0b10 100%); color:#e9e9ef; font-family:-apple-system,system-ui,Segoe UI,Arial; }
    .wrap { padding:14px; max-width:720px; margin:0 auto; }
    .btn { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a2a45; background:#10162f; color:#fff; font-weight:800; }
    .btn:active{ transform:scale(.99); }
    .panel { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; }
    .card { background:transparent; border:none; border-radius:16px; padding:8px 4px; }
    .title { font-weight:700; opacity:.9; margin-bottom:8px; display:flex; justify-content:center; gap:10px; font-size:12px; text-transform:uppercase; letter-spacing:.6px; text-shadow:0 1px 4px rgba(0,0,0,.6); }
    .rows { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 12px; background:#000000; border-radius:999px; margin:2px 0; white-space:nowrap; }
    .k { color:#aeb4c8; font-size:11px; flex:0 0 120px; white-space:nowrap; }
    .v { color:#ffffff; font-weight:700; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-variant-numeric:tabular-nums; text-align:right; flex:1; white-space:nowrap; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <button class="btn" id="startBtn">Iniciar (pedir permissões)</button>

    <div class="panel">
      <div class="card" data-section="gps">
        <div class="title"><span>GPS / Fix</span></div>
        <div class="rows">
          <div class="row"><div class="k">Latitude</div><div class="v" id="lat">—</div></div>
          <div class="row"><div class="k">Longitude</div><div class="v" id="lon">—</div></div>
          <div class="row"><div class="k">Altitude (m)</div><div class="v" id="alt">—</div></div>
          <div class="row"><div class="k">Acc H (m)</div><div class="v" id="hacc">—</div></div>
          <div class="row"><div class="k">AltAcc (m)</div><div class="v" id="vacc">—</div></div>
          <div class="row"><div class="k">Qualidade sinal</div><div class="v" id="sigQ">—</div></div>
          <div class="row"><div class="k">Bearing (°)</div><div class="v" id="bearing">—</div></div>
          <div class="row"><div class="k">Fonte rumo</div><div class="v" id="bearingSrc">—</div></div>
          <div class="row"><div class="k">Speed (km/h)</div><div class="v" id="spd">—</div></div>
          <div class="row"><div class="k">Timestamp</div><div class="v" id="ts">—</div></div>
        </div>
      </div>

      <div class="card" data-section="telemetry">
        <div class="title"><span>Telemetria</span></div>
        <div class="rows">
          <div class="row"><div class="k">Δt GPS (ms)</div><div class="v" id="dtGps">—</div></div>
          <div class="row"><div class="k">Update (s)</div><div class="v" id="updateAge">—</div></div>
          <div class="row"><div class="k">Dist. entre updates (m)</div><div class="v" id="dLast">—</div></div>
          <div class="row"><div class="k">Distância total (m)</div><div class="v" id="dTot">—</div></div>
          <div class="row"><div class="k">Vel. média</div><div class="v" id="vAvg">—</div></div>
          <div class="row"><div class="k">Vel. máx (km/h)</div><div class="v" id="vMax">—</div></div>
          <div class="row"><div class="k">Δ Altitude (m)</div><div class="v" id="dAlt">—</div></div>
          <div class="row"><div class="k">Vel. vertical (m/s)</div><div class="v" id="vVert">—</div></div>
          <div class="row"><div class="k">Ritmo (min/km)</div><div class="v" id="pace">—</div></div>
        </div>
      </div>

      <div class="card" data-section="orientation">
        <div class="title"><span>Orientação</span></div>
        <div class="rows">
          <div class="row"><div class="k">rot alpha</div><div class="v" id="ra">—</div></div>
          <div class="row"><div class="k">rot beta</div><div class="v" id="rb">—</div></div>
          <div class="row"><div class="k">rot gamma</div><div class="v" id="rg">—</div></div>
          <div class="row"><div class="k">compassHeading (°)</div><div class="v" id="cHead">—</div></div>
          <div class="row"><div class="k">compassAccuracy (°)</div><div class="v" id="cAcc">—</div></div>
        </div>
      </div>

      <div class="card" data-section="motion">
        <div class="title"><span>Movimento</span></div>
        <div class="rows">
          <div class="row"><div class="k">acc x</div><div class="v" id="ax">—</div></div>
          <div class="row"><div class="k">acc y</div><div class="v" id="ay">—</div></div>
          <div class="row"><div class="k">acc z</div><div class="v" id="az">—</div></div>
          <div class="row"><div class="k">acc+g x</div><div class="v" id="agx">—</div></div>
          <div class="row"><div class="k">acc+g y</div><div class="v" id="agy">—</div></div>
          <div class="row"><div class="k">acc+g z</div><div class="v" id="agz">—</div></div>
          <div class="row"><div class="k">G-Force (g)</div><div class="v" id="gforce">—</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  function fmt(n, d=6) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(d) : null; }
  function fmt1(n) { return (typeof n === "number" && isFinite(n)) ? n.toFixed(1) : null; }
  function fmt0(n) { return (typeof n === "number" && isFinite(n)) ? String(Math.round(n)) : null; }

  function isEmptyValue(val){
    return val == null || val === "" || val === "—";
  }

  function formatPace(speedMs){
    if (typeof speedMs !== "number" || !isFinite(speedMs) || speedMs <= 0) return null;
    const totalSeconds = 1000 / speedMs;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.round(totalSeconds % 60);
    return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
  }

  function signalQualityFromAccuracy(acc){
    if (typeof acc !== "number" || !isFinite(acc)) return null;
    if (acc <= 10) return "Excelente";
    if (acc <= 30) return "Boa";
    if (acc <= 100) return "Ruim";
    return "Péssima";
  }

  function updateSectionVisibility(card){
    if (!card) return;
    const rows = Array.from(card.querySelectorAll(".row"));
    const hasVisible = rows.some((row) => !row.classList.contains("hidden"));
    card.classList.toggle("hidden", !hasVisible);
  }

  function setField(id, value){
    const el = $(id);
    if (!el) return;
    const row = el.closest(".row");
    if (isEmptyValue(value)){
      el.textContent = "—";
      if (row) row.classList.add("hidden");
    } else {
      el.textContent = value;
      if (row) row.classList.remove("hidden");
    }
    updateSectionVisibility(row ? row.closest(".card") : null);
  }

  // Haversine distance in meters
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const toRad = (x) => x * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  // ---------- GEO ----------
  let watchId = null;
  let lastPos = null;
  let distTotal = 0;
  let vmax = 0;
  let t0 = null;
  let lastCompassHeading = null;

  function startGeo(){
    if (!navigator.geolocation) { return; }

    const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };

    watchId = navigator.geolocation.watchPosition((pos)=>{
      const c = pos.coords;

      setField("lat", fmt(c.latitude, 6));
      setField("lon", fmt(c.longitude, 6));
      setField("alt", fmt1(c.altitude));
      setField("hacc", fmt0(c.accuracy));
      setField("vacc", fmt0(c.altitudeAccuracy));
      setField("sigQ", signalQualityFromAccuracy(c.accuracy));

      const spd = (c.speed == null || c.speed < 0) ? null : c.speed * 3.6;
      setField("spd", spd == null ? null : fmt1(spd));
      if (spd != null) vmax = Math.max(vmax, spd);
      setField("vMax", fmt1(vmax));

      const gpsHeading = (c.heading == null || c.heading < 0) ? null : c.heading;
      const compassHeading = (typeof lastCompassHeading === "number") ? lastCompassHeading : null;
      const bearing = gpsHeading != null ? gpsHeading : compassHeading;
      setField("bearing", bearing == null ? null : fmt0(bearing));
      const bearingSource = gpsHeading != null ? "GPS" : (compassHeading != null ? "Bússola" : null);
      setField("bearingSrc", bearingSource);

      const ts = new Date(pos.timestamp);
      setField("ts", ts.toLocaleTimeString());

      // dt + hz
      if (lastPos){
        const dt = pos.timestamp - lastPos.timestamp;
        setField("dtGps", dt > 0 ? fmt0(dt) : null);

        const d = haversine(lastPos.coords.latitude, lastPos.coords.longitude, c.latitude, c.longitude);
        setField("dLast", fmt1(d));
        distTotal += d;
        setField("dTot", fmt1(distTotal));

        const lastAlt = lastPos.coords.altitude;
        const deltaAlt = (typeof c.altitude === "number" && typeof lastAlt === "number") ? (c.altitude - lastAlt) : null;
        setField("dAlt", deltaAlt == null ? null : fmt1(deltaAlt));
        const dtSec = dt / 1000;
        const vVert = (deltaAlt == null || !dtSec || dtSec <= 0) ? null : (deltaAlt / dtSec);
        setField("vVert", vVert == null ? null : fmt1(vVert));
      } else {
        setField("dtGps", null);
        setField("dLast", null);
        setField("dTot", fmt1(distTotal));
        setField("dAlt", null);
        setField("vVert", null);
      }

      // avg speed since first fix (by distance/time)
      if (!t0) t0 = pos.timestamp;
      const dtTotal = (pos.timestamp - t0) / 1000;
      if (dtTotal > 0){
        const vavg = (distTotal / dtTotal) * 3.6;
        setField("vAvg", fmt1(vavg));
      } else {
        setField("vAvg", null);
      }

      setField("pace", formatPace(c.speed));

      lastPos = pos;

    }, (err)=>{
      console.warn("Geolocation error", err);
    }, opts);
  }

  // update age
  setInterval(()=>{
    if (!lastPos) { setField("updateAge", null); return; }
    setField("updateAge", fmt1((Date.now() - lastPos.timestamp)/1000));
  }, 200);

  // ---------- ORIENTATION ----------
  async function startOrientation(){
    try {
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") { return; }
      }
      window.addEventListener("deviceorientation", (e)=>{
        // iOS-specific (pode existir ou não)
        const ch = e.webkitCompassHeading;
        const ca = e.webkitCompassAccuracy;
        lastCompassHeading = (typeof ch === "number") ? ch : null;
        setField("cHead", (typeof ch === "number") ? fmt0(ch) : null);
        setField("cAcc", (typeof ca === "number") ? fmt0(ca) : null);
      }, true);

    } catch (e) {
      console.warn("Orientation error", e);
    }
  }

  // ---------- MOTION ----------
  async function startMotion(){
    try {
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") { return; }
      }

      window.addEventListener("devicemotion", (e)=>{
        const a = e.acceleration || {};
        const ag = e.accelerationIncludingGravity || {};
        const r = e.rotationRate || {};

        setField("ax", a.x == null ? null : fmt1(a.x));
        setField("ay", a.y == null ? null : fmt1(a.y));
        setField("az", a.z == null ? null : fmt1(a.z));

        setField("agx", ag.x == null ? null : fmt1(ag.x));
        setField("agy", ag.y == null ? null : fmt1(ag.y));
        setField("agz", ag.z == null ? null : fmt1(ag.z));
        const gMag = (typeof ag.x === "number" && typeof ag.y === "number" && typeof ag.z === "number")
          ? Math.sqrt((ag.x ** 2) + (ag.y ** 2) + (ag.z ** 2)) / 9.81
          : null;
        setField("gforce", gMag == null ? null : fmt1(gMag));

        setField("ra", r.alpha == null ? null : fmt1(r.alpha));
        setField("rb", r.beta == null ? null : fmt1(r.beta));
        setField("rg", r.gamma == null ? null : fmt1(r.gamma));
      }, true);

    } catch (e) {
      console.warn("Motion error", e);
    }
  }

  // ---------- START ----------
  $("startBtn").addEventListener("click", async ()=>{
    startGeo();
    await startOrientation();
    await startMotion();
  });

  document.querySelectorAll(".row").forEach((row)=>{
    const value = row.querySelector(".v");
    if (value) {
      const text = value.textContent;
      if (isEmptyValue(text)) {
        row.classList.add("hidden");
      }
    }
    updateSectionVisibility(row.closest(".card"));
  });
</script>
</body>
</html>
